#
# {host}.conf
#

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name {host};

    rewrite ^/(.*)/$ /$1 permanent;
    rewrite ^/(.*)\.html$ /$1 permanent;

    root /home/webhost/hosts/{host}/content;

    # Index routing
    location = / {
        try_files {public_sub_path}/pages/index.html =404;
    }

    location = /index {
        return 301 /;
    }

    # General routing
    location / {
        try_files {public_sub_path}/$uri {public_sub_path}/pages/$uri.html =404;
    }

    {custom}

    # Error routing
    location = /error {
        try_files {public_sub_path}/pages/error.html =404;
    }

    error_page 400 404 /error;
    error_page 500 502 503 504 /error;

    #
    # Expiry
    #
    expires $expires;

    #
    # SSL
    #
    ssl_certificate /etc/letsencrypt/live/{host}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{host}/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

#
# www.{host}
#
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.{host};
    return 301 $scheme://{host}$request_uri;

    ssl_certificate /etc/letsencrypt/live/{host}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{host}/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}
